####################################################################################################
### THIS pf.conf IS MANAGED BY ANSIBLE, CHANGES WILL BE OVERWRITTEN!
####################################################################################################

####################################################################################################
################ options ###############################
set limit states 500000 # increased from default 10000
set limit frags 10000 # increased frm default 5000
set block-policy drop


####################################################################################################
################ macros ################################
if="{{ ansible_default_ipv4.device }}"
nat_if="lo1"
jail_if="lo2"
jail_nat_ip="{{ pf_jail_nat_ip }}"
main_v4_ip="{{ pf_main_v4_ip }}"
main_v6_ip="{{ pf_main_v6_ip }}"


################ common address macros ###############
{{ pf_common_address_macros | default("# No common macros found") }}


################ macros specific to {{ ansible_nodename }} #######################
{{ pf_local_address_macros | default("# No local macros found") }}


####################################################################################################
############### scrubbing ##############################
scrub in on $if all fragment reassemble


####################################################################################################
############### translation NAT ########################
nat on $if from ($nat_if) to ! ($if) -> $jail_nat_ip


############### translation RDR ########################
{{ pf_rdr_rules | default("# No RDR rules found") }}


####################################################################################################
############### filtering ##############################
### block everything
block log all

### skip loopback interface(s)
set skip on lo0

### pass outgoing
pass out quick on $if all
pass out quick on $nat_if all
pass out quick on $jail_if all

### pass incoming icmp to all ip addresses
pass in quick on { $if $jail_if } inet proto icmp all icmp-type { unreach, echoreq, timex }
pass in quick on { $if $jail_if } inet6 proto icmp6 all icmp6-type { echoreq, echorep, neighbradv, neighbrsol, routeradv, routersol }

### pass incoming ssh to host and jails
pass in quick on $if proto tcp from { <allowssh> } to { ($if), ($jail_if) } port 22

### pass v4 traffic from jail to itself on $nat_if
{% for v4ip in hostvars[ansible_host]['ansible_lo1']['ipv4'] %}pass quick on $nat_if from {{ v4ip['address'] }} to {{ v4ip['address'] }}
{% endfor %}

# pass v4 traffic from jails to themselves on $jail_if
{% for v4ip in hostvars[ansible_host]['ansible_lo2']['ipv4'] %}pass quick on $jail_if from {{ v4ip['address'] }} to {{ v4ip['address'] }}
{% endfor %}

# pass v4 traffic from jails to themselves on $if
{% for v4ip in hostvars[ansible_host]['ansible_%s' | format(ansible_default_ipv4.device)]['ipv4'] %}pass quick on $if from {{ v4ip['address'] }} to {{ v4ip['address'] }}
{% endfor %}

### jail rules
{% for jail in pf_jail_rules %}
# {{ jail }} jail
{% for rule in pf_jail_rules[jail] %}
pass in quick on { $if $jail_if $nat_if } proto { {% for proto in rule.protocols %}{{ proto }} {% endfor %} } from { {% for client in rule.clients %}{{ client }}{% endfor %} } to {{ rule.table }} port { {% for port in rule.ports %}{{ port }} {% endfor %}}
{% endfor %}

{% endfor %}

