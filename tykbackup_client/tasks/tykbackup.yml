---
- name: "Install mbuffer"
  pkgng:
    name: "mbuffer"
    state: "present"

- name: "Install periodic tykbackup script"
  copy:
    owner: "root"
    group: "wheel"
    mode: "0755"
    src: "999.tykbackup"
    dest: "/usr/local/etc/periodic/daily/999.tykbackup"

- name: "configure tykbackup"
  blockinfile:
    dest: "/etc/periodic.conf"
    create: yes
    marker: "# {mark} ANSIBLE MANAGED BLOCK tykbackup"
    block: |
      #daily tykbackup
      daily_tykbackup_enable="YES"
      daily_tykbackup_targethost="{{ tykbackup_target_host }}"
      daily_tykbackup_targetuser="{{ tykbackup_target_user }}"
      daily_tykbackup_targetfs="{{ tykbackup_target_zfs }}"
      daily_tykbackup_pools="{{ tykbackup_pools | join(' ') }}"
      daily_tykbackup_skip="{{ tykbackup_skip_datasets | default([]) | join(' ') }}"

- name: "make sure we have an ssh key for root"
  user:
    name: "root"
    ssh_key_type: "ed25519"
    generate_ssh_key: True

