@version:3.13
@include "scl.conf"

#
# these options are suitable for.. what?
#
options {
    chain_hostnames(no);
    flush_lines(0);
    threaded(yes);
    use_fqdn(yes);
    keep_hostname(no);
    use-dns(yes);
    dns-cache-hosts(/etc/hosts);
    stats-freq(60);
    stats-level(0);
}; 

##################### SOURCES ##############################

source src {
    {% if syslogng_tls_listener | default(True) %}
    syslog(
        ip("127.0.0.1")
        port("1999")
        transport("tls")
        tls(
            key_file("/usr/home/{{ certgrinder_user }}/certificates/{{ ansible_nodename }}.key")
            cert_file("/usr/home/{{ certgrinder_user }}/certificates/{{ ansible_nodename }}.crt")
        )
    );
    syslog(
        ip("::1")
        port("1999")
        transport("tls")
        ip-protocol(6)
        tls(
            key_file("/usr/home/{{ certgrinder_user }}/certificates/{{ ansible_nodename }}.key")
            cert_file("/usr/home/{{ certgrinder_user }}/certificates/{{ ansible_nodename }}.crt")
        )
    );
    {% endif %}
    udp(
        ip("127.0.0.1")
    );
    udp6(
        ip("::1")
    )
};

##################### DESTINATIONS ##############################

{% if syslogng_upstream_server or syslogng_upstream_elk %}
destination remote{
    {% if syslogng_upstream_server %}
    syslog(
        "{{ syslogng_upstream_server }}"
        transport("tls")
        port(1999)
        tls(peer-verify(required-trusted))
        log-fifo-size(100000)
    );
    {% endif %}
    {% if syslogng_upstream_elk %}
    tcp(
        "127.0.0.1"
        port(5000)
        log-fifo-size(100000)
    );
    {% endif %}
};
{% endif %}

destination file{
    file("/var/log/syslogng/${HOST}/${YEAR}-${MONTH}-${DAY}/${FACILITY}.log"
    template("${YEAR}-${MONTH}-${DAY} ${HOUR}:${MIN}:${SEC} ${TZ} ${HOST} [${FACILITY}.${LEVEL}] ${MESSAGE}\n")
    template-escape(no));
}

##################### LOGGING ##############################

log { source(src); destination(remote); flags(flow-control); };
log { source(src); destination(file); flags(flow-control); };

